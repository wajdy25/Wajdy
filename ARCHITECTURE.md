# تصميم معماري لتطبيق الشخصية الأنمي التفاعلية

## 1. نظرة عامة على المعمارية

### الهيكل العام:
```
AnimeCharacterApp/
├── app/
│   ├── src/main/java/com/animecharacter/
│   │   ├── activities/
│   │   │   ├── MainActivity.kt
│   │   │   └── SettingsActivity.kt
│   │   ├── services/
│   │   │   ├── FloatingCharacterService.kt
│   │   │   ├── AIService.kt
│   │   │   └── VoiceService.kt
│   │   ├── models/
│   │   │   ├── Character.kt
│   │   │   ├── Conversation.kt
│   │   │   └── Settings.kt
│   │   ├── utils/
│   │   │   ├── PermissionHelper.kt
│   │   │   ├── AnimationHelper.kt
│   │   │   └── StorageHelper.kt
│   │   └── views/
│   │       ├── FloatingCharacterView.kt
│   │       └── ChatBubbleView.kt
│   ├── src/main/res/
│   │   ├── layout/
│   │   ├── drawable/
│   │   ├── raw/ (ملفات الشخصيات)
│   │   └── values/
│   └── src/main/AndroidManifest.xml
└── gradle files
```

## 2. المكونات الرئيسية

### 2.1 FloatingCharacterService
- **الوظيفة**: إدارة النافذة العائمة والشخصية
- **المسؤوليات**:
  - إنشاء وإدارة WindowManager
  - التعامل مع اللمس والسحب
  - تحديث موقع وحجم الشخصية
  - إدارة الرسوم المتحركة

### 2.2 AIService
- **الوظيفة**: التواصل مع OpenAI API
- **المسؤوليات**:
  - إرسال الطلبات إلى ChatGPT
  - معالجة الاستجابات
  - إدارة سياق المحادثة
  - التعامل مع الأخطاء

### 2.3 VoiceService
- **الوظيفة**: إدارة الصوت (TTS & STT)
- **المسؤوليات**:
  - تحويل النص إلى صوت
  - التعرف على الكلام
  - إدارة إعدادات الصوت
  - التحكم في الميكروفون

## 3. تدفق البيانات

### سيناريو المحادثة النصية:
1. المستخدم يكتب رسالة في واجهة التطبيق
2. MainActivity ترسل النص إلى AIService
3. AIService يرسل الطلب إلى OpenAI API
4. الاستجابة تُعرض في ChatBubbleView
5. VoiceService يحول النص إلى صوت
6. FloatingCharacterService يعرض الرسوم المتحركة

### سيناريو المحادثة الصوتية:
1. المستخدم يضغط على زر الميكروفون
2. VoiceService يبدأ التسجيل والتعرف على الكلام
3. النص المُحول يُرسل إلى AIService
4. باقي الخطوات مثل السيناريو النصي

## 4. إدارة الحالة

### SharedPreferences للإعدادات:
- موقع الشخصية الأخير
- حجم الشخصية
- مستوى الشفافية
- إعدادات الصوت
- الشخصية المختارة

### قاعدة بيانات محلية (Room):
- تاريخ المحادثات (اختياري)
- الشخصيات المحملة
- الإعدادات المتقدمة

## 5. الأمان والخصوصية

### حماية API Key:
- تشفير المفتاح في BuildConfig
- استخدام ProGuard لحماية الكود
- عدم تخزين المفتاح في SharedPreferences

### إدارة الصلاحيات:
- طلب صلاحية SYSTEM_ALERT_WINDOW
- طلب صلاحية RECORD_AUDIO
- إشعارات الخصوصية عند تشغيل الميكروفون

## 6. تحسين الأداء

### إدارة الذاكرة:
- تحميل الصور بشكل كسول
- إعادة تدوير الرسوم المتحركة
- تنظيف الموارد عند عدم الاستخدام

### إدارة البطارية:
- إيقاف الخدمات غير الضرورية
- تحسين تكرار التحديثات
- استخدام JobScheduler للمهام المؤجلة

## 7. التوافق والاختبار

### دعم إصدارات أندرويد:
- الحد الأدنى: API 23 (Android 6.0)
- الهدف: API 34 (Android 14)
- اختبار على أجهزة مختلفة

### اختبار الوظائف:
- اختبار النوافذ العائمة
- اختبار دمج AI
- اختبار الصوت
- اختبار الأداء

